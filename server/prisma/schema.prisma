// Prisma schema for SourcePlus Licensing Server

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String    @id @default(uuid())
  name         String
  email        String    @unique
  passwordHash String
  role         Role      @default(developer)
  createdAt    DateTime  @default(now())
  lastLoginAt  DateTime?
  lastLoginIp  String?
  sessions     Session[]
  auditLogs    AuditLog[]
  replies      SupportReply[]
  messageReplies MessageReply[]
}

model Session {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshToken String @unique
  userAgent  String?
  ip         String?
  expiresAt  DateTime
  createdAt  DateTime @default(now())
}

model Plan {
  id             String       @id @default(uuid())
  name           String
  durationMonths Int          @default(12)
  
  // Deprecated legacy fields (kept for safety)
  priceUSD       Float?
  price_monthly  Float?
  price_yearly   Float?
  currency       String?      @default("IQD")
  
  limits         Json?
  features       Json
  deviceLimit    Int          @default(1)
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  prices         PlanPrice[]
  licenses       License[]
}

model PlanPrice {
  id           String  @id @default(uuid())
  planId       String
  currency     String
  monthlyPrice Float?
  periodPrice  Float?
  yearlyPrice  Float?
  discount     Float?   // percentage discount
  isPrimary    Boolean @default(false)

  plan Plan @relation(fields: [planId], references: [id], onDelete: Cascade)
  @@unique([planId, currency])
}

model Currency {
  id         String   @id @default(uuid())
  code       String   @unique
  rate       Float
  symbol     String
  lastUpdated DateTime @default(now())
}

model License {
  id              String        @id @default(uuid())
  serial          String        @unique
  planId          String
  plan            Plan          @relation(fields: [planId], references: [id], onDelete: Cascade)
  customerName    String
  deviceLimit     Int
  activationCount Int           @default(0)
  hardwareId      String?
  activationDate  DateTime?
  expireDate      DateTime?
  status          LicenseStatus @default(pending)
  lastRenewalDate DateTime?
  isPaused        Boolean       @default(false)
  lastCheckIn     DateTime?
  productType     ProductType   @default(POS)
  clinic          Clinic?
  createdAt       DateTime      @default(now())
  transactions    Transaction[]
  tickets         SupportTicket[]
  devices         Device[]
}

model AppVersion {
  id           String   @id @default(uuid())
  version      String
  releaseNotes String
  downloadUrl  String
  forceUpdate  Boolean  @default(false)
  isActive     Boolean  @default(true)
  releaseDate  DateTime @default(now())
  createdAt    DateTime @default(now())
}

model Notification {
  id           String   @id @default(uuid())
  title        String
  body         String
  targetSerial String?
  channel      String?
  productType  ProductType @default(POS)
  isRead       Boolean  @default(false)
  sentAt       DateTime @default(now())
}

model SupportTicket {
  id            String       @id @default(uuid())
  licenseId     String?
  license       License?     @relation(fields: [licenseId], references: [id], onDelete: SetNull)
  serial        String
  hardwareId    String
  deviceName    String
  systemVersion String
  phoneNumber   String
  appVersion    String
  description   String
  status        TicketStatus @default(open)
  adminReply    String?
  replyAt       DateTime?
  createdAt     DateTime     @default(now())
  replies       SupportReply[]
  attachments   Attachment[]
}

model SupportReply {
  id        String   @id @default(uuid())
  ticketId  String
  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  message   String
  createdAt DateTime @default(now())
}

model Attachment {
  id         String   @id @default(uuid())
  ticketId   String
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  path       String
  mimeType   String
  size       Int
  createdAt  DateTime @default(now())
}

model Transaction {
  id           String             @id @default(uuid())
  licenseId    String?
  license      License?           @relation(fields: [licenseId], references: [id], onDelete: SetNull)
  customerName String
  planName     String
  amount       Float
  currency     String
  type         TransactionType
  status       TransactionStatus  @default(completed)
  reference    String?
  date         DateTime           @default(now())
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    String
  details   String
  ipAddress String?
  productType ProductType @default(POS)
  createdAt DateTime @default(now())
}

model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
}

model RemoteConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  description String?
  updatedAt DateTime @updatedAt
}

model Device {
  id              String    @id @default(uuid())
  licenseId       String
  license         License   @relation(fields: [licenseId], references: [id], onDelete: Cascade)
  hardwareId      String
  deviceName      String
  appVersion      String
  systemVersion   String?
  activationDate  DateTime  @default(now())
  lastCheckIn     DateTime  @default(now())
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([licenseId, hardwareId])
  @@index([hardwareId])
}

model Config {
  id                String    @id @default(uuid())
  maintenance_mode  Boolean   @default(false)
  support_phone     String    @default("+9647700000000")
  features          Json      @default("{}")
  updatedAt         DateTime  @updatedAt
}

model TrafficLog {
  id         String   @id @default(uuid())
  timestamp  DateTime @default(now())
  method     String
  endpoint   String
  status     Int
  serial     String?
  hardwareId String?
  ipAddress  String?
  userAgent  String?
  payload    Json?
  response   Json?
  durationMs Float?

  @@index([timestamp])
  @@index([method])
  @@index([status])
  @@index([serial])
  @@index([endpoint])
}

enum Role {
  admin
  developer
  viewer
}

enum LicenseStatus {
  active
  expired
  revoked
  pending
  paused
}

enum TicketStatus {
  open
  in_progress
  resolved
}

enum TransactionType {
  purchase
  renewal
  refund
  adjustment
}

enum TransactionStatus {
  completed
  pending
  failed
  cancelled
}

model SupportMessage {
  id        String   @id @default(uuid())
  name      String
  serial    String?
  message   String
  status    String   @default("pending") // pending, resolved, closed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  replies   MessageReply[]
}

model MessageReply {
  id        String         @id @default(uuid())
  messageId String
  message   SupportMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String
  user      User           @relation(fields: [userId], references: [id])
  reply     String
  createdAt DateTime       @default(now())
}

model Clinic {
  id            String             @id @default(uuid())
  name          String
  doctorName    String?
  email         String             @unique
  phone         String?
  address       String?
  hwid          String             @unique
  systemVersion String?
  status        RegistrationStatus @default(PENDING)
  
  licenseId     String?            @unique
  license       License?           @relation(fields: [licenseId], references: [id])

  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  @@map("clinics")
}

enum ProductType {
  POS
  CLINIC
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}
