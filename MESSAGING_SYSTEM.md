# ๐ฌ ูุธุงู ุงููุญุงุฏุซุฉ ุงููุจุงุดุฑุฉ ููุนูุงุฏุงุช - Direct Messaging System

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅูุดุงุก ูุธุงู ูุญุงุฏุซุฉ ูุจุงุดุฑ ุงุญุชุฑุงูู ููุชูุงุตู ูุน ุงูุนูุงุฏุงุช ุจุฏูุงู ูู Notifications ู Support Tickets. ุงููุธุงู ูููุฑ ูุงุฌูุฉ chat ุญุฏูุซุฉ ูููุธูุฉ ุชูุงูุงู ูุซู ุชุทุจููุงุช ุงููุฑุงุณูุฉ ุงูุดููุฑุฉ.

---

## โจ ุงููููุฒุงุช ุงูุฑุฆูุณูุฉ

### 1. **ูุงุฌูุฉ ููุธูุฉ ูุฌูููุฉ**
- ๐ฑ ุชุตููู ุซูุงุฆู ุงูุฃุนูุฏุฉ (ูุงุฆูุฉ ุงููุญุงุฏุซุงุช + ููุทูุฉ ุงูุฏุฑุฏุดุฉ)
- ๐จ ูุชูุงูู ุชูุงูุงู ูุน ุซูู ุงูุชุทุจูู
- ๐ ุนุฑุถ ุขุฎุฑ ุฑุณุงูุฉ ูู ูู ูุญุงุฏุซุฉ
- ๐ ุนุฏุงุฏ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ
- โฐ ูุนูููุงุช ุงูููุช ุงูุฐููุฉ (Just now, 5m ago, 2h ago, 3d ago)

### 2. **ุฅุฏุงุฑุฉ ุงููุญุงุฏุซุงุช**
- โ ูุงุฆูุฉ ุฌููุน ุงููุญ ุงุฏุซุงุช ูุน ุงูุนูุงุฏุงุช
- โ ุจุญุซ ุณุฑูุน ูู ุงููุญุงุฏุซุงุช
- โ ุฃุฑุดูุฉ ูุฅูุบุงุก ุฃุฑุดูุฉ ุงููุญุงุฏุซุงุช
- โ ุญุฐู ุงููุญุงุฏุซุงุช
- โ ุชุจุฏูู ุจูู Active ู Archived

### 3. **ุงููุญุงุฏุซุฉ ุงููุนููุฉ**
- ๐ฌ ุฅุฑุณุงู ูุงุณุชูุจุงู ุงูุฑุณุงุฆู
- โ๏ธ ุนูุงูุงุช ุงููุฑุงุกุฉ (Read receipts)
- ๐ ุชุญุฏูุซ ุชููุงุฆู ูู 10 ุซูุงูู
- โจ๏ธ ุฅุฑุณุงู ุจู Enterุ ุณุทุฑ ุฌุฏูุฏ ุจู Shift+Enter
- ๐ textarea ูุฑุณุงุฆู ุทูููุฉ

### 4. **ูุนูููุงุช ุงูุนูุงุฏุฉ**
- ๐ฅ ุงุณู ุงูุนูุงุฏุฉ
- ๐จโโ๏ธ ุงุณู ุงูุทุจูุจ
- ๐ง ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
- ๐ญ Avatar ุจุฃูู ุญุฑู ูู ุงุณู ุงูุนูุงุฏุฉ

---

## ๐๏ธ ุงูุจููุฉ ุงูุชูููุฉ (Database Schema)

### Model: `Conversation`
```prisma
model Conversation {
  id            String
  clinicId      String
  clinic        Clinic
  subject       String?           // ููุถูุน ุงููุญุงุฏุซุฉ (ุงุฎุชูุงุฑู)
  lastMessageAt DateTime          // ุขุฎุฑ ุฑุณุงูุฉ
  unreadCount   Int              // ุนุฏุฏ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ
  status        String           // active, archived
  messages      ClinicMessage[]
  createdAt     DateTime
  updatedAt     DateTime
}
```

### Model: `ClinicMessage`
```prisma
model ClinicMessage {
  id             String
  conversationId String
  conversation   Conversation
  senderId       String
  sender         User
  message        String @db.Text
  isRead         Boolean
  createdAt      DateTime
}
```

---

## ๐ API Endpoints

### 1. **GET /api/messages/conversations**
ุงูุญุตูู ุนูู ุฌููุน ุงููุญุงุฏุซุงุช
```json
Response: [
  {
    "id": "uuid",
    "clinicId": "uuid",
    "clinic": {
      "name": "ุนูุงุฏุฉ ุงูุฃูู",
      "email": "clinic@test.com",
      "doctorName": "ุฏ. ุฃุญูุฏ"
    },
    "lastMessageAt": "2025-12-14T10:00:00Z",
    "unreadCount": 3,
    "status": "active",
    "messages": [
      {
        "id": "uuid",
        "message": "ุขุฎุฑ ุฑุณุงูุฉ",
        "sender": { ... },
        "createdAt": "2025-12-14T10:00:00Z"
      }
    ]
  }
]
```

### 2. **GET /api/messages/conversations/:id**
ุงูุญุตูู ุนูู ูุญุงุฏุซุฉ ูุญุฏุฏุฉ ูุน ุฌููุน ุงูุฑุณุงุฆู
- ุชููุงุฆูุงู ูุญุฏุฏ ุงูุฑุณุงุฆู ูููุฑูุกุฉ
- ูุตูุฑ ุนุฏุงุฏ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ

### 3. **POST /api/messages/conversations/:id/messages**
ุฅุฑุณุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉ
```json
Request: {
  "message": "ูุต ุงูุฑุณุงูุฉ"
}

Response: {
  "id": "uuid",
  "message": "ูุต ุงูุฑุณุงูุฉ",
  "sender": {
    "id": "uuid",
    "name": "Admin",
    "role": "admin"
  },
  "createdAt": "2025-12-14T10:00:00Z"
}
```

### 4. **POST /api/messages/conversations**
ุฅูุดุงุก ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ
```json
Request: {
  "clinicId": "uuid",
  "subject": "ููุถูุน ุงุฎุชูุงุฑู",
  "initialMessage": "ุฑุณุงูุฉ ุงุจุชุฏุงุฆูุฉ ุงุฎุชูุงุฑูุฉ"
}
```

### 5. **PATCH /api/messages/conversations/:id/archive**
ุฃุฑุดูุฉ ูุญุงุฏุซุฉ

### 6. **PATCH /api/messages/conversations/:id/unarchive**
ุฅูุบุงุก ุฃุฑุดูุฉ ูุญุงุฏุซุฉ

### 7. **DELETE /api/messages/conversations/:id**
ุญุฐู ูุญุงุฏุซุฉ

### 8. **GET /api/messages/conversations/unread/count**
ุงูุญุตูู ุนูู ุนุฏุฏ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ ุงูููู

---

## ๐จ ููููุงุช ุงููุงุฌูุฉ

### 1. **ูุงุฆูุฉ ุงููุญุงุฏุซุงุช (Left Panel)**
```tsx
- Search bar
- Active/Archived toggle button
- ูุงุฆูุฉ ุงููุญุงุฏุซุงุช:
  - Avatar ุงูุนูุงุฏุฉ
  - ุงุณู ุงูุนูุงุฏุฉ + ุงุณู ุงูุทุจูุจ
  - ุขุฎุฑ ุฑุณุงูุฉ (preview)
  - ุงูููุช
  - Badge ุนุฏุฏ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ
```

### 2. **ููุทูุฉ ุงูุฏุฑุฏุดุฉ (Right Panel)**
```tsx
- Header:
  - ูุนูููุงุช ุงูุนูุงุฏุฉ
  - ุฃุฒุฑุงุฑ: Archive, Delete, Close (mobile)
  
- Messages Area:
  - ุฑุณุงุฆู ุงูุฃุฏูู (ููููุ ุฃุฎุถุฑ)
  - ุฑุณุงุฆู ุงูุนูุงุฏุฉ (ูุณุงุฑุ ุฃุจูุถ)
  - ุชูููุช ูู ุฑุณุงูุฉ
  - ุนูุงูุฉ ุงููุฑุงุกุฉ โโ
  
- Input Area:
  - Textarea ูููุชุงุจุฉ
  - ุฒุฑ ุฅุฑุณุงู
  - ูุตูุญุฉ: Enter = ุฅุฑุณุงู
```

---

## ๐ก ุณูุฑ ุงูุนูู

### ูููุดุฑู (Admin):
```
1. ููุชุญ ุตูุญุฉ Messages
2. ูุฑู ูุงุฆูุฉ ูู ุงููุญุงุฏุซุงุช
3. ูุฎุชุงุฑ ูุญุงุฏุซุฉ
4. ููุฑุฃ ุงูุฑุณุงุฆู (ุชุตุจุญ ููุฑูุกุฉ ุชููุงุฆูุงู)
5. ูุฑุฏ ุนูู ุงูุนูุงุฏุฉ
6. ููููู ุฃุฑุดูุฉ/ุญุฐู ุงููุญุงุฏุซุฉ
```

### ุขููุฉ ุงูุชุญุฏูุซ:
```
- ุงูุชุญุฏูุซ ุงูุชููุงุฆู ูู 10 ุซูุงูู
- ุงูุชุญุฏูุซ ุนูุฏ ุงูุชุฑููุฒ ุนูู ุงูุตูุญุฉ
- ุงูุชุญุฏูุซ ุจุนุฏ ุฅุฑุณุงู ุฑุณุงูุฉ
```

---

## ๐ ุงููููุงุช ุงููููุดุฃุฉ/ุงูููุนุฏููุฉ

### Backend (4 ูููุงุช)
```
1. server/prisma/schema.prisma
   - Conversation model
   - ClinicMessage model
   - Relations

2. server/src/modules/messages/routes.ts (ุฌุฏูุฏ)
   - ุฌููุน endpoints ุงููุญุงุฏุซุงุช

3. server/src/routes.ts
   - ุฅุถุงูุฉ messagesRoutes

4. Clinic & User models
   - ุฅุถุงูุฉ relations
```

### Frontend (4 ูููุงุช)
```
1. client/pages/ClinicMessages.tsx (ุฌุฏูุฏ)
   - ุงูุตูุญุฉ ุงููุงููุฉ ูููุญุงุฏุซุงุช

2. client/services/api.ts
   - ุฌููุน API methods ูููุญุงุฏุซุงุช

3. client/App.tsx
   - ุฅุถุงูุฉ route ููู clinic-messages

4. client/components/Layout.tsx
   - ุฅุถุงูุฉ Messages ูู menu
```

---

## ๐ฏ ุงููููุฒุงุช ุงูุชูููุฉ

### 1. **Real-time Updates**
```typescript
useEffect(() => {
  fetchConversations();
  const interval = setInterval(fetchConversations, 10000);
  return () => clearInterval(interval);
}, []);
```

### 2. **Auto-scroll to Bottom**
```typescript
useEffect(() => {
  if (selectedConversation) {
    scrollToBottom();
  }
}, [selectedConversation?.messages]);
```

### 3. **Smart Time Formatting**
```typescript
const formatTime = (dateString) => {
  // Just now, 5m ago, 2h ago, 3d ago
};
```

### 4. **Read Receipts**
```typescript
// ุนูุฏ ูุชุญ ูุญุงุฏุซุฉ:
- ุชุญุฏูุซ isRead = true ููู ุงูุฑุณุงุฆู
- ุชุตููุฑ unreadCount
```

---

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### 1. ุชุดุบูู ุงูู Migration
```bash
cd server
npx prisma migrate dev --name add-clinic-messaging
npx prisma generate
```

### 2. ุฅุนุงุฏุฉ ุชุดุบูู ุงูู Server
```bash
npm run dev
```

### 3. ูุชุญ ุงูุชุทุจูู
```
1. ุณุฌู ุฏุฎูู ููุดุฑู (Admin)
2. ุงุถุบุท ุนูู "Messages" ูู ุงููุงุฆูุฉ
3. ุงุณุชูุชุน ุจูุธุงู ุงููุญุงุฏุซุฉ! ๐
```

---

## ๐ฑ ุงูุดูู ุงูููุงุฆู

### Desktop View
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Messages                        [Archive]  โ
โ  โโโโโโโโโโโโโโโ                            โ
โ  โ   Search    โ                            โ
โ  โโโโโโโโโโโโโโโ                            โ
โโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  [๐ต] Clinic 1  โ  [๐ค] Clinic Name        โ
โ  Last msg...    โ  โโโโโโโโโโโโโโโโโโโโโ   โ
โ  5m ago     [3] โ  โโโโโโโโโโโโโโโโโโโโ   โ
โ                  โ  โ Their message    โ   โ
โ  [๐ข] Clinic 2  โ  โโโโโโโโโโโโโโโโโโโโ   โ
โ  Last msg...    โ                          โ
โ  1h ago         โ      โโโโโโโโโโโโโโโโ   โ
โ                  โ      โ Your reply   โ   โ
โ  [๐ก] Clinic 3  โ      โโโโโโโโโโโโโโโโ   โ
โ  Last msg...    โ  โโโโโโโโโโโโโโโโโโโโโ   โ
โ  2d ago         โ  [ Type message... ] [โ] โ
โโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Mobile View
```
ูุชุญูู ุฅูู view ูุงุญุฏุฉ:
- ูุงุฆูุฉ ุงููุญุงุฏุซุงุช (ุงูุชุฑุงุถูุงู)
- ุนูุฏ ุงุฎุชูุงุฑ ูุญุงุฏุซุฉ โ chat fullscreen
- ุฒุฑ X ููุฑุฌูุน ูููุงุฆูุฉ
```

---

## โ ุงูุฎูุงุตุฉ

### ุชู ุฅูุดุงุก:
โ ูุธุงู ูุญุงุฏุซุฉ ูุงูู ููุชูุงูู  
โ ูุงุฌูุฉ ุญุฏูุซุฉ ูุณูุณุฉ  
โ ุชุญุฏูุซ ุชููุงุฆู  
โ ุฅุฏุงุฑุฉ ูุงููุฉ ูููุญุงุฏุซุงุช  
โ ูุชูุงูู ูุน ุซูู ุงูุชุทุจูู  
โ responsive ุชูุงูุงู  
โ ุนูุงูุงุช ูุฑุงุกุฉ  
โ ุฃุฑุดูุฉ ูุญุฐู  

### ุงุณุชุจุฏู:
โ Notifications (ูู ูุณู ุงูุนูุงุฏุงุช)  
โ Support Tickets (ูู ูุณู ุงูุนูุงุฏุงุช)  
โ ุจูุธุงู ูุญุงุฏุซุฉ ูุจุงุดุฑ ูุงุญุฏ ููุธู

**ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู! ๐๐ฌ**
