# تقرير SourcePlus الكامل

هذا المستند يلخّص كل ما هو موجود في مستودع **SourcePlus**، ويشرح دور كل ملف ووحدة، وكيف يتكامل النظام لتقديم خادم تراخيص متكامل ولوحة تحكم للإدارة.

---

## 1. لمحة عامة عن النظام
- **الغرض**: منصة مركزية لبيع التراخيص لمشاريع سطح المكتب / نقاط البيع، مع أدوات لمتابعة التحديثات، النسخ الاحتياطي، الدعم الفني والتحليلات المالية.
- **المجمّع (Monorepo)**: الجذر يحتوي سكربتات إدارة لتشغيل الواجهة (`client/`) والخادم (`server/`) معاً، إضافةً إلى ملفات النشر (Docker، Compose، Nginx).
- **المكوّنات الرئيسة**:
  - خادم Fastify مكتوب بـ TypeScript يستعمل Prisma/PostgreSQL.
  - واجهة React + Vite توفر لوحة تحكم ثنائية اللغة (عربي/إنجليزي) وتدعم الوضع الليلي.
  - جداول مراقبة متقدمة، تسجيل زيارات تلقائي، وسكربت نسخ احتياطي مجدول عبر `node-cron`.

---

## 2. المكدّس والتشغيل
| العنصر | التفاصيل |
| --- | --- |
| الخادم | Fastify 4 + Zod + Prisma 7 + PostgreSQL + JWT + Argon2/Bcrypt |
| الواجهة | React 19 + Vite 6 + TypeScript + Tailwind (يدوياً عبر CSS متغيّرات) + Lucide + Recharts + MUI Selective components |
| التخزين | PostgreSQL (نماذج Prisma مذكورة لاحقاً)، دعم نسخ JSON، وسكربت `pg_dump` للنسخ الكاملة |
| الحاويات | `Dockerfile.frontend` للواجهة، `server/Dockerfile` للخادم، و `docker-compose.yml` لتشغيل DB + PgAdmin + الخدمات |
| البيئة | متغيّرات `.env` مطلوبة: `DATABASE_URL`, `JWT_SECRET`, `PORT` للخادم، و `VITE_API_URL` للواجهة |

---

## 3. الملفات الجذرية
| الملف | الوظيفة |
| --- | --- |
| `package.json` | سكربتات عليا (`dev`, `install:all`, `start`) وتشغيل متزامن للخادم/الواجهة عبر `concurrently`. كما يضيف تبعية `node-cron` لتشغيل مهام خارجية من الجذر إن لزم. |
| `package-lock.json` / `node_modules/` | تثبيت حزم الجذر لتشغيل سكربتات التطوير (لا تُعدّل يدويًا). |
| `README.md` | مستند رئيسي يشرح البنية، خطوات التشغيل، ومتطلبات النشر على Render. |
| `UI_ENHANCEMENTS.md` | ملاحظات توثّق تحسينات تم إنجازها بواجهة الخطط والتنبيهات. |
| `Dockerfile.frontend` / `server/Dockerfile` / `nginx.conf` | ملفات بناء الحاويات. الأول يبني واجهة Vite ثم يخدّمها Nginx، والثاني يبني Fastify + Prisma. |
| `docker-compose.yml` | تعريف خدمات التطوير (Postgres، PgAdmin، الخادم، الواجهة) مع منافذها وربط المتغيّرات. |
| `services/` | مساحة لخدمات JavaScript مشتركة خارج الواجهة (موضحة لاحقًا). |

---

## 4. خادم Fastify (`server/`)

### 4.1 ملفات الأساس
| الملف | الدور |
| --- | --- |
| `src/main.ts` | نقطة الدخول: يبني التطبيق، يطبق مسار `/api` الخاص بواجهات العملاء، يشغّل `runSeed` للتأكد من وجود ادمن، ثم يبدأ الاستماع على كل البطاقات. |
| `src/app.ts` | إنشاء مثيل Fastify مع إضافات `cors`, `sensible`, `multipart`, `jwt`, وإلحاق إضافات مخصّصة (`prisma`, `auth`, `client`). يعرّف Healthcheck، ويستدعي `registerRoutes`. كما يحتوي Hook `onResponse` الذي يسجّل كل الطلبات تحت `/api/*` في جدول `TrafficLog`. |
| `src/routes.ts` | تجميع الوحدات: يسجل مسارات المصادقة، المستخدمين، الخطط، العملات، التراخيص، التنبيهات، التذاكر، الإعدادات، النسخ الاحتياطي، التحليلات، نسخة العميل العامة، الدعم، وسجلات المرور. |

### 4.2 الإضافات (Plugins)
| الملف | الوظيفة |
| --- | --- |
| `plugins/prisma.ts` | يهيّئ PrismaClient باستخدام `@prisma/adapter-pg`، ويدعم الاتصالات الآمنة تلقائيًا على بيئات الاستضافة. يضيف المثيل إلى جميع الطلبات. |
| `plugins/auth.ts` | يعرّف `app.authenticate` للتحقق من JWT و `app.authorize` لفرض أدوار (admin/developer/viewer). |
| `plugins/client.ts` | يضيف `verifyClient` لاستخلاص الـ serial / hardwareId من الهيدر أو الطلب، ويمنع الطلبات العامة بدون serial. |

### 4.3 الخدمات والأدوات
| الملف | الوظيفة |
| --- | --- |
| `services/backup.scheduler.ts` | صنف `BackupScheduler` يستخدم `node-cron` لتشغيل أوامر `pg_dump` تلقائيًا، تنظيف النسخ الأقدم من الحد الأقصى، وكتابة أحداث Audit. يمكن استدعاؤه مستقبلًا عبر `initializeBackupScheduler`. |
| `utils/audit.ts` | دالة `logAudit` المركزية لإنشاء سجلات الأحداث مع حماية من الأخطاء. |
| `utils/serial.ts` | توليد Serial بنمط `SP-YYYY-XXXX-XXXX-XXXX` (أو TR للتجارب)، وتحديد الحالة الافتراضية للتراخيص. |
| `seed.ts` | ضمان وجود مستخدم admin افتراضي (Super Admin) بكلمة مرور معروفة للتشغيل الأول. |

### 4.4 الوحدات (Modules)
كل وحدة عبارة عن ملف `routes.ts` مع عمليات CRUD مضبوطة والتحقق عبر Zod، والكثير منها يسجّل الأحداث في Audit.

| الوحدة | المسار | المهام |
| --- | --- | --- |
| `modules/auth/routes.ts` | `/auth` | تسجيل الدخول (JWT + جلسات refresh)، إنشاء مستخدمين جدد (admin فقط)، تحديث token، واستعلام `/me`. |
| `modules/users/routes.ts` | `/users` | عرض/إنشاء/حذف المستخدمين مع هاش Bcrypt وصلاحيات admin فقط. |
| `modules/plans/routes.ts` | `/plans` | CRUD الخطط مع أسعار متعددة العملات (PlanPrice)، تفعيل/تعطيل، وتسجيل الأحداث. |
| `modules/plans/public.routes.ts` | `/api/plans` | واجهة عامة تعرض الخطط النشطة + الأسعار لنشرها للعميل. |
| `modules/currencies/routes.ts` | `/currencies` | إدارة العملات، مزامنة تلقائية لمعدلات الصرف (باستعلام API أو قيم افتراضية)، وحذف/تعديل. |
| `modules/licenses/routes.ts` | `/licenses` | استعلام التراخيص، توليد Serial جماعي، تحديث الحالة، التجديد، الإيقاف (pause)، الإلغاء، والحذف. ينشئ معاملات مالية تلقائيًا. |
| `modules/licensing/*` | `/api` (public) | واجهات العميل النهائي: التحقق من الترخيص، التفعيل، معرفة حالة الاشتراك، التحقق من التحديثات، مزامنة الإعدادات، وتقديم تذاكر دعم عامة. |
| `modules/client/routes.ts` | `/client` | نفس وظائف `/api` ولكن بصيغة بديلة (تحقق، تفعيل، نبض heartbeat، تحديث HWID، عرض الخطط، دعم). يمكن استخدامها لتطبيقات سطح المكتب مباشرة. |
| `modules/notifications/routes.ts` | `/notifications` | إدارة التنبيهات (إرسال عام أو لعميل محدد، حذف فردي أو كامل). |
| `modules/tickets/routes.ts` | `/tickets` | تذاكر الدعم الداخلية: إنشاء، الرد، وضع الحالة، رفع مرفقات، وحذف. |
| `modules/support/routes.ts` | `/api/support/messages` | صندوق رسائل منفصل: استقبال شكاوى عامة بدون تسجيل دخول، واستعراضها/تحديثها من قبل المشرفين. |
| `modules/versions/routes.ts` | `/versions` | إدارة نسخ التطبيق (إصدار، Force Update، تنزيل، حذف). |
| `modules/settings/routes.ts` | `/settings` | قراءة/تحديث الإعدادات الداخلية، الإعدادات البعيدة (Remote Config)، وتنفيذ إعادة ضبط للنظام (تحذف البيانات المرتبطة بالتراخيص). |
| `modules/analytics/routes.ts` | `/analytics` | إحصاءات مبيعات/تراخيص، صحة الخادم (قِيَم افتراضية)، المعاملات، والرسوم البيانية الشهرية. |
| `modules/audit/routes.ts` | `/audit-logs` | عرض آخر 200 سجل، ومسح السجلات مع حفظ سجل بأن الحذف تم. |
| `modules/backup/routes.ts` | `/backup` | إنشاء/تحميل/رفع/استرجاع/حذف النسخ بصيغة JSON (تحوي بيانات المستخدمين، الخطط، التراخيص، إلخ). الاسترجاع يعيد بناء العلاقات بالترتيب الصحيح. |
| `modules/traffic/*` | `/traffic` | واجهات تصفية واستعراض سجلات الزيارات التي يدوّنها Hook `onResponse`، وإمكانية مسحها مع إدخال Audit. |
| `modules/notifications/routes.ts` | `/notifications` | (مذكورة أعلاه) |

### 4.5 Prisma وقاعدة البيانات
- **الملفات**: `prisma/schema.prisma`, `prisma/migrations/*`, `prisma.config.ts`.
- **النماذج الرئيسة**: `User`, `Session`, `Plan`, `PlanPrice`, `License`, `Device`, `Transaction`, `SupportTicket`, `SupportReply`, `Attachment`, `Notification`, `AuditLog`, `SystemSetting`, `RemoteConfig`, `TrafficLog`, `SupportMessage`, `MessageReply`, بالإضافة إلى Enums (`Role`, `LicenseStatus`, ...).
- **ملاحظات**:
  - `TrafficLog` يحتوي مؤشرات متعددة لدعم الاستعلامات.
  - `SupportTicket` يحتفظ بعلاقات لمرفقات وردود (Cascade).
  - `Backup` يستند إلى تصدير JSON لتلك النماذج من خلال معاملات Prisma متداخلة.

### 4.6 سكربتات إضافية
| الملف | الغرض |
| --- | --- |
| `check_users.ts` | سكربت CLI لعرض المستخدمين عبر Prisma (للتأكد من الاتصال). |
| `test_argon*.ts` | سكربتات تجريبية للتأكد من صحة Hashات Argon2. |
| `dist/` | ناتج التحويل `tsc` الذي يُشغّل في الإنتاج. لا يُحرر يدويًا. |

---

## 5. واجهة الإدارة (`client/`)

### 5.1 تهيئة ومداخل
| الملف | الوظيفة |
| --- | --- |
| `package.json` | تعريف حزم React/Vite، وإضافات مثل `lucide-react`, `recharts`, `xlsx`, ومكونات MUI. |
| `vite.config.ts` | يحدد `VITE_API_URL`, مجلد البناء `build/`, والـ alias `@`. |
| `tsconfig.json` | إعدادات TypeScript (ESNext، JSX، strict). |
| `index.html` / `index.tsx` | نقطة تحميل التطبيق وتفعيل StrictMode. |
| `App.tsx` | الحاوية الرئيسة: تسجيل الدخول، تبديل الوضع الليلي، تبديل اللغة، جدولة تحديثات تلقائية، إدارة المسارات الداخلية (Dashboard, Licenses, Plans, …) مع تفعيل AutoRefresh وسحب الإعدادات لتطبيق الألوان الديناميكية. |
| `metadata.json` | بيانات تعريف للاستخدام مع منصات نشر (اسم ووصف). |
| `build/` | ناتج Vite production (لا يُعدل). |

### 5.2 المكونات المشتركة
| المكون | الوصف |
| --- | --- |
| `components/Layout.tsx` | إطار اللوحة: شريط جانبي، قوائم بحسب الدور (admin/developer)، تغيير اللغة والوضع الليلي، وإظهار المستخدم الحالي. |
| `components/ConfirmModal.tsx` | مربع حوار للتأكيد بأنماط Danger/Warning/Info. يستعمل في الحذف، التفعيل، إلخ. |
| `components/TrafficLogs.tsx` | أداة عرض حي لسجلات `/traffic` مع فلترة حسب الطريقة/الكود/البحث، تفصيل الطلب، ومسح السجلات. |

### 5.3 Hooks و Utilities
| الملف | الغرض |
| --- | --- |
| `hooks/useTranslation.tsx` | نظام ترجمة بسيط يستعمل `localStorage`، EventTarget داخلي لتزامن اللغة، ويحدث اتجاه الصفحة. |
| `hooks/useAutoRefresh.tsx` | سياق يوفر عدّاد تحديث يُستخدم لإعادة جلب البيانات بشكل موحد. |
| `locales.ts` | نصوص اللغة (إنجليزي/عربي) لكل الأقسام (دخول، إعدادات، الخطط، …). |
| `types.ts` | تعريفات TypeScript لجميع الكيانات (User, License, Plan, Transaction, ServerHealth, ...). |
| `utils/excelExport.ts` | تصدير بيانات إلى Excel مع ضبط عرض الأعمدة وتلوين العناوين. |

### 5.4 الخدمات
| الملف | الوصف |
| --- | --- |
| `services/api.ts` | عميل REST موحّد: يخزن Tokens في localStorage أو sessionStorage بحسب خيار "تذكرني"، يدير عملية Refresh Token، ويغطي كل نهايات الخادم (تراخيص، خطط، عملات، تذاكر، تنبيهات، نسخ احتياطية، تحليلات، إلخ). |
| `services/mockBackend.ts` | محاكاة لواجهة برمجية (Seed بيانات، مولد تراخيص، معاملات مزيفة). مفيد لعمل Demo دون خادم حقيقي؛ غير مستخدم في الإنتاج ولكنه مرجع لتجهيز بيانات الاختبار. |

### 5.5 الصفحات (pages/)
| الملف | الوظيفة |
| --- | --- |
| `Dashboard.tsx` | لوحة شاملة: بطاقات إحصائية (تراخيص نشطة/منتهية، إيرادات)، مخططات Recharts، صحة الخادم، نشاط Audit آخر 5 أحداث، تفعيل AutoRefresh. |
| `Licenses.tsx` | إدارة التراخيص: إنشاء دفعات، فلترة حسب الخطة/الحالة، تحرير الأسماء، تجديد الاشتراك، تفعيل/إيقاف، توليد أكواد تفعيل غير متصل، وتصدير البيانات. |
| `Plans.tsx` | واجهة غنية لإدارة الخطط، مع Templates، تحرير خصائص JSON (features/limits)، أسعار متعددة العملات، معاينة بطاقات العرض، وإشعارات نجاح/فشل. |
| `Currencies.tsx` | عرض وتحـديث أسعار العملات، إضافة عملات جديدة، مزامنة تلقائية مع API خارجي أو قيم بديلة، ونوافذ تأكيد الحذف. |
| `Updates.tsx` | نشر إصدارات التطبيق: إنشاء/تعديل نسخة، Force Update، تحميل ملف تجريبي، تبديل حالة النسخة، وعرض جدول الإصدارات. |
| `Support.tsx` | إدارة تذاكر الدعم الواردة من العملاء (تفاصيل الجهاز/السيريال، الردود، وضع التذاكر كـ Resolved، حذف). |
| `Notifications.tsx` | إرسال تنبيهات (Templates جاهزة، فلترة حسب النوع، بحث، إحصاءات عامة، مسح السجل أو التنبيه المحدد). |
| `Settings.tsx` | تبويب للإعدادات العامة، إعدادات الخادم، قنوات التنبيه، Remote Config، والنسخ الاحتياطي (إنشاء، تنزيل، رفع، استرجاع، حذف). كما يدعم تحديث اللون الأساسي وتطبيقه. |
| `ApiDocs.tsx` | توثيق تفاعلي لنقاط `/api` و`/auth`، مع نماذج طلب/استجابة وقابلية نسخ الكود. |
| `Team.tsx` | إدارة أعضاء الفريق (إنشاء حسابات بأدوار مختلفة، عرض المستخدمين، حذفهم، التحقق من كلمة المرور). |
| `AuditLogs.tsx` | عرض سجلات النظام وتصديرها إلى Excel، مسح السجل مع تأكيد، والتحويل إلى تبويب `TrafficLogs` المضمّن. |
| `Financials.tsx` | لوحات مالية (الإيراد الكلي/اليومي/الشهري، جدول المعاملات، فلترة، تصدير، عرض تفاصيل الفاتورة وطباعتها). |
| `Login.tsx` | صفحة الدخول مع فحص حالة الخادم، دعم "تذكرني"، قياس زمن الاستجابة، وإظهار أخطاء واضحة بالعربية/الإنجليزية. |
| `SystemInfo.tsx` | صفحة توثيق عربية بالكامل تشرح المزايا التقنية، المكدس، والأمان (قد تُستخدم كصفحة تسويقية داخلية). |

---

## 6. مجلد `services/` في الجذر
| الملف | الوصف |
| --- | --- |
| `services/api.ts` | نسخة قديمة من عميل REST (تستورد `../types` غير الموجود بالجذر). يمكن اعتبارها بقايا قبل نقل الواجهة إلى `client/`. يُنصح إما بحذفها أو توحيدها مع عميل الواجهة الحالي لمنع الالتباس. |

---

## 7. البنية التحتية والأدلة الداعمة
| الملف/المجلد | التفاصيل |
| --- | --- |
| `Dockerfile.frontend` | يبني الواجهة في مرحلة منفصلة ثم ينسخ الناتج إلى Nginx. يسمح بتمرير `VITE_API_URL` أثناء البناء. |
| `server/Dockerfile` | يعتمد بناء متعدد المراحل (تثبيت الحزم، توليد Prisma، بناء TypeScript، ثم تشغيل نسخة خفيفة). |
| `docker-compose.yml` | يشغّل Postgres + PgAdmin + backend + frontend. يربط المتغيرات وت exposes المنافذ (`5432`, `5050`, `3001`, `4173`). |
| `nginx.conf` | إعداد بسيط لإعادة كتابة الطلبات إلى `index.html` (Single Page App). |
| `UI_ENHANCEMENTS.md` | يوثّق التحسينات على واجهة الخطط والتنبيهات (بطاقات حديثة، دعم ثنائي اللغة، إصلاحات زر الدعم). |

---

## 8. تدفق العمل والبيانات
1. **ابتداءً من الخادم**: كل الطلبات تمر عبر `app.ts`، حيث تُتحقق JWT ويُسجّل المسار في `TrafficLog`. المعاملات الحساسة (إنشاء خطط، تراخيص، نسخ احتياطية) تُسجل في `AuditLog`.
2. **التراخيص**: مسار لوحة التحكم (`/licenses`) يستدعي API الإداري (`/licenses/*`). أما التطبيقات العميلة فتستخدم `/api/license/*` أو `/client/*` للتفعيل والتحقق الدوري.
3. **النسخ الاحتياطية**: يمكن إنشاؤها يدويًا من لوحة الإعدادات (`/backup` API)، أو تلقائيًا عبر `BackupScheduler` عند تفعيل متغيرات البيئة الخاصة به.
4. **الإعدادات البعيدة**: `RemoteConfig` يحدد خصائص مثل `maintenance_mode` ويُستدعى من العميل عبر `/api/config/sync` أو من الواجهة عبر `/settings/remote`.

---

## 9. الأمان والمراقبة
- **المصادقة**: JWT مع Access/Refresh، تخزين الجلسات في جدول `Session`، وحد Hooks تمنع الوصول في حالة غياب tokens.
- **الأدوار**: كل المسارات الحساسة تستخدم `app.authorize`. يتم فصل مسؤوليات admin/developer/viewer كذلك في واجهة المستخدم.
- **السجلات**: `AuditLog` لتتبع العمليات الحساسة، و`TrafficLog` لكل طلب خارجي. الواجهة توفر تبويبات لنظرة مباشرة وتصدير.
- **سلامة البيانات**: استرجاع النسخ الاحتياطية يتم داخل معاملة لضمان تتابع العلاقات. كما تُستخدم Zod للتحقق من Payload قبل أي كتابة.

---

## 10. ملاحظات وتوصيات
1. **تنظيف مجلد `services/` الجذري**: ملف `services/api.ts` يعتمد على مسار Types غير موجود، ما يشير إلى كونه غير مستخدم. إزالته أو دمجه سيقلل الالتباس.
2. **تفعيل المجدول**: `BackupScheduler` موجود لكنه غير مستدعى في `main.ts`. إذا كانت النسخ الآلية مطلوبة، يجب استدعاء `initializeBackupScheduler(app)` بعد جاهزية التطبيق وضبط متغيرات `AUTO_BACKUP_ENABLED`, `BACKUP_SCHEDULE`, `BACKUP_PATH`.
3. **التوثيق العربي الرسمي**: `README.md` يشير إلى `SYSTEM_OVERVIEW_AR.md` غير الموجود. يمكن استخدام هذا الملف (`SYSTEM_REPORT_AR.md`) أو إنشاء مستند إضافي مختصر للرابط المذكور.
4. **مراقبة القيم العشوائية**: `analytics/routes.ts` يعيد جزءًا من بيانات السيرفر بقيم عشوائية (استخدام `Math.random`). لإنتاج حقيقي يفضل استبدالها بقراءات حقيقية أو إزالة الحقول الوهمية.
5. **واجهة العميل المزدوجة**: توجد واجهتان (`/api` و`/client`). تأكد من توحيد سلوكهما أو توثيق الفرق لتفادي التداخل عند تحديثات مستقبلية.

---

بهذا يكون لديك وصف كامل لكل ملف ومجلد في النظام، مع شرح المعمارية، قواعد البيانات، الواجهات، وأدوات النشر. يمكن اعتماد هذا المستند كمرجع رسمي لفريق التطوير أو للتسليم لجهة تدقيق خارجية. بالتوفيق.
